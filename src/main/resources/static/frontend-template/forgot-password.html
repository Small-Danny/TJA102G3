<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>忘記密碼</title>
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/bootstrap.min.css">
    <link rel="icon" type="image/x-icon" href="/frontend-template/assets/images/heading-icon.png">
    <link rel="stylesheet" href="/frontend-template/assets/font/flaticon_mycollection.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/style.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/responsive.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/header.css">
    <style>
        /* CSS 樣式與您原本的相同，此處省略 */
        .box.forgot-password{background-color:#f5f5f5;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-top:20px}.box.forgot-password h3{color:#333;text-align:center;margin-bottom:25px;font-weight:600}.form-group{margin-bottom:20px;position:relative}.box.forgot-password input{width:100%;padding:12px 15px;background-color:#fff;border:1px solid #ddd;border-radius:4px;color:#333;font-size:16px;box-sizing:border-box}.box.forgot-password input::placeholder{color:#999}.captcha-container{display:flex;gap:10px;align-items:center}.captcha-container input{flex:1;margin-bottom:0;height:46px}#captchaImage{width:120px;height:46px;border:1px solid #ddd;border-radius:4px;cursor:pointer}.error-message{color:#dc3545;font-size:14px;margin-top:5px;display:none}.error-message.show{display:block}.success-message{color:#28a745;font-size:16px;text-align:center;margin-bottom:20px;display:none}.success-message.show{display:block}.theme-btn{background-color:#EA2127;color:white;border:none;padding:12px 20px;border-radius:4px;cursor:pointer;font-size:16px;font-weight:500;transition:all .3s ease;width:100%;margin-bottom:15px}.theme-btn:hover{background-color:#bb2d3b}.theme-btn:disabled{background-color:#ccc;cursor:not-allowed}.back-link{text-align:center;display:block;color:#007bff;text-decoration:none}@media (max-width:576px){.captcha-container{flex-direction:column}#captchaImage{width:100%}}
    </style>
</head>
<body>
    <div id="header"></div>
    <section class="banner-style-one">
        <div class="parallax" style="background-image: url(https://via.placeholder.com/1920x640);"></div>
        <div class="container"><div class="row"><div class="banner-details">
            <h2>忘記密碼</h2><p>請輸入您的電子郵件與圖片驗證碼，獲取重置連結</p>
        </div></div></div>
    </section>
    <section class="gap login-register">
        <div class="container"><div class="row justify-content-center"><div class="col-lg-6">
            <div class="box forgot-password">
                <h3>忘記密碼</h3>
                <div class="success-message" id="successMessage"></div>
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <input type="email" name="email" id="email" placeholder="電子郵件地址" required>
                        <div class="error-message" id="emailError"></div>
                    </div>
                    <div class="form-group">
                        <div class="captcha-container">
                            <input type="text" name="captcha" id="captcha" placeholder="圖片驗證碼" required>
                            <img src="/api/captcha" id="captchaImage" alt="驗證碼圖片">
                        </div>
                        <div class="error-message" id="captchaError"></div>
                    </div>
                    <button type="submit" class="theme-btn" id="submitBtn">發送重置連結</button>
                   <a href="/frontend-template/login.html">返回登入頁面</a>
                </form>
            </div>
        </div></div></div>
    </section>

   <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 加載頁首
            fetch('/frontend-template/header.txt?v=' + Date.now(), { cache: 'no-store' })
                .then(r => r.text())
                .then(html => { document.getElementById('header').innerHTML = html; });

            const form = document.getElementById('forgotPasswordForm');
            const submitBtn = document.getElementById('submitBtn');
            const captchaImage = document.getElementById('captchaImage');
            const successMessage = document.getElementById('successMessage');

            function showError(field, message) { /* ... 輔助函式 ... */ }
            function clearErrors() { /* ... 輔助函式 ... */ }

            captchaImage.addEventListener('click', function() {
                this.src = '/api/captcha?t=' + new Date().getTime();
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                clearErrors();
                
                // 【修改 1】在請求發送前，立刻禁用按鈕並更新文字
                submitBtn.disabled = true;
                submitBtn.textContent = '發送中...';

                const email = document.getElementById('email').value;
                const captcha = document.getElementById('captcha').value;
                
                fetch('/api/users/request-password-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        captcha: captcha
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.text();
                })
                .then(message => {
                    successMessage.textContent = message;
                    successMessage.classList.add('show');
                    form.style.display = 'none';
                    // 成功時按鈕不用恢復，因為表單已隱藏
                })
                .catch(error => {
                    console.error('請求失敗:', error);
                    if (error.field && error.message) {
                        showError(error.field + 'Error', error.message);
                    } else {
                        alert('發生未知錯誤，請稍後再試。');
                    }
                    // 【修改 2】在請求失敗後，恢復按鈕狀態
                    submitBtn.disabled = false;
                    submitBtn.textContent = '發送重置連結';
                    captchaImage.click(); // 自動刷新驗證碼
                });
            });
        });
    </script>
</body>
</html>