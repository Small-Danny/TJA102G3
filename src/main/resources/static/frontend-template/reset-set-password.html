<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重設密碼</title>
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/bootstrap.min.css">
    <link rel="icon" type="image/x-icon" href="/frontend-template/assets/images/heading-icon.png">
    <link rel="stylesheet" href="/frontend-template/assets/font/flaticon_mycollection.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/fontawesome.min.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/style.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/responsive.css">
    <link rel="stylesheet" type="text/css" href="/frontend-template/assets/css/header.css">
    <style>
        .box.reset-password{background-color:#f5f5f5;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}.box.reset-password h3{color:#333;text-align:center;margin-bottom:25px;font-weight:600}.box.reset-password p{color:#666;text-align:center;margin-bottom:30px}.form-group{position:relative;padding-bottom:22px;margin-bottom:5px}.box.reset-password input{width:100%;padding:12px 15px;background-color:#fff;border:1px solid #ddd;border-radius:4px;color:#333;font-size:16px;height:46px;box-sizing:border-box;transition:all .2s ease}.box.reset-password input:focus{outline:none;border-color:#EA2127;box-shadow:0 0 0 2px rgba(234,33,39,.2)}.password-wrapper{position:relative}.box.reset-password .password-wrapper input{padding-right:40px!important}.toggle-password{position:absolute;right:15px;top:50%;transform:translateY(-50%);cursor:pointer;color:#555}.error-message{color:#dc3545;font-size:13px;display:none;position:absolute;bottom:0;left:0;margin-bottom:5px}.error-message.show{display:block}.password-strength{height:5px;margin-top:8px;border-radius:3px;background-color:#eee;overflow:hidden;display:none}.password-strength.show{display:block}.strength-bar{height:100%;width:0;transition:width .3s ease}.strength-weak{width:33%;background-color:#dc3545}.strength-medium{width:66%;background-color:#ff8c00}.strength-strong{width:100%;background-color:#28a745}.password-hint{font-size:13px;color:#666;margin-top:8px;margin-bottom:5px;padding:8px 12px;background-color:#e9ecef;border-radius:4px;border-left:3px solid #6c757d}.theme-btn{background-color:#EA2127;color:white;border:none;padding:12px 20px;border-radius:4px;cursor:pointer;font-size:16px;font-weight:500;transition:all .3s ease;width:100%;margin-top:15px;display:flex;align-items:center;justify-content:center;box-sizing:border-box}.theme-btn:hover{background-color:#bb2d3b}.back-link{text-align:center;display:block;color:#007bff;text-decoration:none;margin-top:15px}input[type=password]::-ms-reveal{display:none}
    </style>
</head>
<body>
    <header><div id="header"></div></header>
    <section class="banner-style-one">
        <div class="parallax" style="background-image: url(https://via.placeholder.com/1920x640);"></div>
        <div class="container">
            <div class="row"><div class="banner-details"><h2>重設密碼</h2><p>請設定您的新密碼</p></div></div>
        </div>
    </section>
    <section class="gap login-register">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="box reset-password">
                        <h3>設定您的新密碼</h3>
                        <p id="page-description">請輸入並確認您的新密碼。</p>
                        <form id="resetPasswordForm">
                            <div class="form-group">
                                <div class="password-wrapper">
                                    <input type="password" name="newPassword" id="newPassword" placeholder="新密碼" required>
                                    <i class="fa-solid fa-eye toggle-password" data-target="newPassword"></i>
                                </div>
                                <div class="password-strength"><div class="strength-bar" id="strengthBar"></div></div>
                                <div class="password-hint">密碼強度：至少8位，包含大寫字母、小寫字母、數字和特殊字符</div>
                                <div class="error-message" id="newPasswordError"></div>
                            </div>
                            <div class="form-group">
                                <div class="password-wrapper">
                                    <input type="password" name="confirmPassword" id="confirmPassword" placeholder="確認密碼" required>
                                    <i class="fa-solid fa-eye toggle-password" data-target="confirmPassword"></i>
                                </div>
                                <div class="error-message" id="confirmPasswordError"></div>
                            </div>
                            <button type="submit" class="theme-btn">確認重置密碼</button>
                            <a href="/frontend-template/login.html" class="back-link">返回登入頁面</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // --- 輔助函式 (完整版) ---
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        }
        function clearAllErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
                el.classList.remove('show');
            });
        }
        
        // --- 主邏輯 ---
        document.addEventListener('DOMContentLoaded', function () {
            // 加載頁首
            fetch('header.txt?v=' + Date.now(), { cache: 'no-store' })
                .then(r => r.text())
                .then(html => { document.getElementById('header').innerHTML = html; });

            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const pageDescription = document.getElementById('page-description');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const strengthBar = document.getElementById('strengthBar');
            const passwordStrength = document.querySelector('.password-strength');

            // --- 區塊 1：頁面載入時，從網址獲取並驗證 Token ---
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                pageDescription.textContent = '無效或缺失的重設連結，請返回忘記密碼頁面重新申請。';
                pageDescription.style.color = 'red';
                resetPasswordForm.style.display = 'none'; // 找不到 Token，直接隱藏整個表單
                return;
            }

            // --- 區塊 2：密碼可視性切換 (完整版) ---
            document.querySelectorAll('.toggle-password').forEach(icon => {
                icon.addEventListener('click', function () {
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.classList.toggle('fa-eye');
                    this.classList.toggle('fa-eye-slash');
                });
            });

            // --- 區塊 3：密碼強度檢測 (完整版) ---
            newPasswordInput.addEventListener('input', function () {
                const password = this.value;
                passwordStrength.classList.toggle('show', password.length > 0);
                if (password.length === 0) {
                    strengthBar.className = 'strength-bar';
                    return;
                }
                let strength = 0;
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                strengthBar.className = 'strength-bar';
                if (strength <= 2) strengthBar.classList.add('strength-weak');
                else if (strength <= 4) strengthBar.classList.add('strength-medium');
                else strengthBar.classList.add('strength-strong');
            });

            // --- 區塊 4：表單提交邏輯 (Token 流程版) ---
            resetPasswordForm.addEventListener('submit', function (e) {
                e.preventDefault();
                clearAllErrors();
                let isValid = true;
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // 前端驗證
                const pwdRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,}$/;
                if (!pwdRegex.test(newPassword)) {
                    showError('newPasswordError', '密碼不符合要求，須包含大小寫、數字及特殊符號，且不少於8位');
                    isValid = false;
                } else if (newPassword !== confirmPassword) {
                    showError('confirmPasswordError', '兩次輸入的密碼不一致');
                    isValid = false;
                }

                if (isValid) {
                    fetch('/api/users/reset-password-with-token', { // 【重要】後端 API 路徑建議修改
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: token,
                            newPassword: newPassword,
                            confirmPassword: confirmPassword
                        })
                    })
  .then(response => {
                        // 【核心修正】
                        if (!response.ok) {
                            // 失敗時，後端回傳 JSON 格式的錯誤訊息，所以這裡用 .json() 是對的
                            return response.json().then(err => { throw err; });
                        }
                        // 成功時，後端回傳純文字訊息 "密碼重設成功..."，所以這裡必須用 .text()
                        return response.text();
                    })
                    .then(message => {
                        // 成功接收到純文字訊息
                        alert(message || '密碼已成功重設！3秒後將跳轉至登入頁面...');
                        setTimeout(() => { window.location.href = '/frontend-template/login.html'; }, 3000);
                    })
                    .catch(error => {
                        // 處理請求失敗或後端拋出的 JSON 錯誤
                        console.error('重設密碼失敗:', error);
                        pageDescription.textContent = error.message || '重設失敗，連結可能已過期或無效。';
                        pageDescription.style.color = 'red';
                    });
                }
            });
        });
    </script>
</body>
</html>